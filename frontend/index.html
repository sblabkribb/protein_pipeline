<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>K-Biofoundry | Protein Pipeline Console</title>
    <link rel="stylesheet" href="./styles.css?v=20260223e" />
  </head>
  <body>
    <div class="bg-orb orb-a" aria-hidden="true"></div>
    <div class="bg-orb orb-b" aria-hidden="true"></div>
    <div class="bg-grid" aria-hidden="true"></div>

    <header class="topbar">
      <div class="brand">
        <div class="brand-mark">KBF</div>
        <div class="brand-text">
          <div class="brand-title">K-Biofoundry</div>
          <div class="brand-subtitle">Protein Pipeline Console</div>
        </div>
      </div>
      <div class="topbar-actions">
        <button id="settingsBtn" class="ghost">Settings</button>
        <button id="logoutBtn" class="ghost">Logout</button>
      </div>
    </header>

    <main class="layout">
      <section class="panel panel-chat">
        <div id="loginGate" class="login-gate">
          <div class="login-card">
            <h1>Enter the Lab</h1>
            <p>Identify yourself to separate runs and keep artifacts organized.</p>
            <label>
              Username
              <input id="loginUsername" type="text" placeholder="e.g. hana.kim" />
            </label>
            <label>
              Password
              <input id="loginPassword" type="password" placeholder="••••••••" />
            </label>
            <button id="loginBtn" class="primary">Access Console</button>
            <div id="loginError" class="hint"></div>
          </div>
        </div>

        <div id="chatArea" class="chat-area hidden">
          <div class="chat-header">
            <div>
              <h2>Run Setup</h2>
              <p>Select what to run, attach inputs, and launch the job.</p>
            </div>
            <div class="user-badge" id="userBadge"></div>
          </div>

          <div id="messages" class="messages"></div>

          <div class="composer">
            <div class="composer-row">
              <textarea
                id="promptInput"
                rows="3"
                placeholder="Optional notes for this run (no prompt required)."
              ></textarea>
              <div class="composer-actions">
                <button id="planBtn" class="primary">Reset Inputs</button>
                <button id="clearBtn" class="ghost">Clear</button>
              </div>
            </div>
          </div>

          <div id="questionStack" class="question-stack"></div>

          <div class="run-actions">
            <button id="runBtn" class="primary" disabled>Run</button>
            <div id="runHint" class="hint">Complete required inputs to enable execution.</div>
          </div>

          <div id="settingsPanel" class="settings-panel hidden">
            <div class="settings-card">
              <h4>API Settings</h4>
              <div class="settings-fixed">
                <div class="settings-label">MCP HTTP Base URL</div>
                <div id="apiBaseValue" class="settings-value"></div>
                <div class="hint">This value is fixed by the server configuration.</div>
              </div>
              <div class="settings-actions">
                <button id="healthCheck" class="ghost">Health Check</button>
              </div>
              <div id="healthStatus" class="hint"></div>
              <div id="adminPanel" class="admin-panel hidden">
                <h4>Admin: Create User</h4>
                <label>
                  New Username
                  <input id="adminUsername" type="text" placeholder="new.user" />
                </label>
                <label>
                  New Password
                  <input id="adminPassword" type="password" placeholder="min 8 chars" />
                </label>
                <label>
                  Role
                  <select id="adminRole">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                  </select>
                </label>
                <div class="settings-actions">
                  <button id="adminCreateUser" class="primary">Create User</button>
                </div>
                <div id="adminStatus" class="hint"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <aside class="panel panel-side">
        <div class="side-section">
          <h3>Run Monitor</h3>
          <div class="status-card">
            <div class="status-row">
              <span class="label">Run ID</span>
              <span id="runIdValue" class="value">-</span>
            </div>
            <div class="status-row">
              <span class="label">Stage</span>
              <span id="runStageValue" class="value">-</span>
            </div>
            <div class="status-row">
              <span class="label">State</span>
              <span id="runStateValue" class="value">-</span>
            </div>
            <div class="status-row">
              <span class="label">Updated</span>
              <span id="runUpdatedValue" class="value">-</span>
            </div>
            <div class="status-subtitle">Scoring</div>
            <div class="score-row score-row-compact">
              <div class="score-pill" id="runScoreValue">Score: -</div>
              <div class="score-pill" id="runEvidenceValue">Evidence: -</div>
              <div class="score-pill" id="runRecommendationValue">Recommendation: -</div>
            </div>
            <div class="status-actions">
              <button id="pollBtn" class="ghost">Poll Now</button>
              <label class="toggle">
                <input id="autoPoll" type="checkbox" checked />
                <span>Auto Poll</span>
              </label>
            </div>
            <div class="status-subtitle">Recent Runs</div>
            <div id="runList" class="run-list"></div>
            <label id="adminRunsToggle" class="toggle hidden">
              <input id="showAllRuns" type="checkbox" />
              <span>Show all runs (admin)</span>
            </label>
          </div>
        </div>

        <div class="side-section">
          <h3>Artifacts</h3>
          <div class="artifact-controls">
            <input id="artifactFilter" type="text" placeholder="Filter by name or stage" />
            <button id="refreshArtifacts" class="ghost">Refresh</button>
          </div>
          <div id="artifactList" class="artifact-list"></div>
        </div>

        <div class="side-section">
          <h3>Feedback</h3>
          <div class="status-card feedback-card">
            <div class="form-row">
              <span class="label">Rating</span>
              <div id="feedbackRating" class="choice-group"></div>
            </div>
            <div class="form-row">
              <span class="label">Reasons</span>
              <div id="feedbackReasons" class="choice-group"></div>
            </div>
            <div class="form-row">
              <label>
                Artifact (optional)
                <select id="feedbackArtifact"></select>
              </label>
              <label>
                Stage (optional)
                <select id="feedbackStage"></select>
              </label>
            </div>
            <label>
              Comment
              <textarea id="feedbackComment" rows="3" placeholder="Short context or interpretation"></textarea>
            </label>
            <button id="submitFeedback" class="primary">Submit Feedback</button>
            <div class="form-row export-actions">
              <button id="exportFeedbackCsv" class="ghost">Export CSV</button>
              <button id="exportFeedbackTsv" class="ghost">Export TSV</button>
            </div>
            <div id="feedbackStatus" class="hint"></div>
            <div class="status-subtitle">Recent Feedback</div>
            <div id="feedbackList" class="run-list"></div>
          </div>
        </div>

        <div class="side-section">
          <h3>Experiment</h3>
          <div class="status-card feedback-card">
            <div class="form-row">
              <label>
                Assay Type
                <select id="experimentAssay"></select>
              </label>
              <label>
                Result
                <select id="experimentResult"></select>
              </label>
            </div>
            <div class="form-row">
              <label>
                Sample ID (optional)
                <input id="experimentSampleId" type="text" placeholder="e.g. seq_001" />
              </label>
              <label>
                Artifact (optional)
                <select id="experimentArtifact"></select>
              </label>
            </div>
            <label>
              Metrics (JSON, optional)
              <textarea id="experimentMetrics" rows="3" placeholder='{"kd_nM": 12.5, "t50_C": 48}'></textarea>
            </label>
            <label>
              Conditions / Notes
              <textarea id="experimentConditions" rows="3" placeholder="Buffer, temperature, assay details"></textarea>
            </label>
            <button id="submitExperiment" class="primary">Submit Experiment</button>
            <div class="form-row export-actions">
              <button id="exportExperimentCsv" class="ghost">Export CSV</button>
              <button id="exportExperimentTsv" class="ghost">Export TSV</button>
            </div>
            <div id="experimentStatus" class="hint"></div>
            <div class="status-subtitle">Recent Experiments</div>
            <div id="experimentList" class="run-list"></div>
          </div>
        </div>

        <div class="side-section">
          <h3>Report</h3>
          <div class="status-card feedback-card">
            <div class="score-row">
              <div class="score-pill" id="reportScoreValue">Score: -</div>
              <div class="score-pill" id="reportEvidenceValue">Evidence: -</div>
              <div class="score-pill" id="reportRecommendationValue">Recommendation: -</div>
            </div>
            <label>
              Report (Markdown)
              <textarea id="reportContent" rows="6" placeholder="Generate or edit the report"></textarea>
            </label>
            <div class="form-row report-actions">
              <button id="loadReport" class="ghost">Load</button>
              <button id="generateReport" class="ghost">Generate</button>
              <button id="saveReport" class="primary">Save</button>
            </div>
            <div id="reportStatus" class="hint"></div>
            <div class="status-subtitle">Artifact Links</div>
            <div id="reportArtifactLinks" class="report-links"></div>
          </div>
        </div>

        <div class="side-section">
          <h3>Artifact Preview</h3>
          <div id="artifactPreview" class="artifact-preview">
            <div class="placeholder">Select an artifact to preview it here.</div>
          </div>
        </div>
      </aside>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/3dmol@2.0.4/build/3Dmol-min.js"></script>
    <script type="module" src="./app.js?v=20260223e"></script>
  </body>
</html>
